name: Code Quality & Analysis, Build, push and deploy
on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  code-quality-analysis:
    name: Code Quality & Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: ""

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Cache Node dependencies
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: ${{ runner.os }}-node-

      - name: Lint backend (Java)
        continue-on-error: true
        working-directory: backend
        run: |
          # URL encode the branch names before fetching
          BASE_REF=$(echo "${{ github.base_ref }}" | sed 's/(/\\(/g; s/)/\\)/g')
          HEAD_REF=$(echo "${{ github.head_ref }}" | sed 's/(/\\(/g; s/)/\\)/g')

          git fetch origin "$BASE_REF"
          git fetch origin "$HEAD_REF"

          CHANGED_FILES=$(git diff --name-only --diff-filter=d "origin/$BASE_REF".."origin/$HEAD_REF" 2>/dev/null | grep -E '\.java$' | tr '\n' ' ' || echo "")

          if [ ! -z "$CHANGED_FILES" ]; then
            echo "Checking changed Java files: $CHANGED_FILES"
            mvn spotless:check -Dspotless.check.skip=false
          else
            echo "No Java files changed. Skipping lint."
            exit 0
          fi

      - name: Lint frontend (TypeScript/React)
        continue-on-error: true
        working-directory: frontend
        run: |
          # URL encode the branch names before fetching
          BASE_REF=$(echo "${{ github.base_ref }}" | sed 's/(/\\(/g; s/)/\\)/g')
          HEAD_REF=$(echo "${{ github.head_ref }}" | sed 's/(/\\(/g; s/)/\\)/g')

          git fetch origin "$BASE_REF"
          git fetch origin "$HEAD_REF"

          CHANGED_FILES=$(git diff --name-only --diff-filter=d "origin/$BASE_REF".."origin/$HEAD_REF" 2>/dev/null | grep -E '\.(ts|tsx|js|jsx)$' | tr '\n' ',' | sed 's/,$//' || echo "")

          if [ ! -z "$CHANGED_FILES" ]; then
            echo "Checking changed frontend files: $CHANGED_FILES"
            npm ci
            npm run lint
          else
            echo "No frontend files changed. Skipping lint."
            exit 0
          fi

      - name: Install SonarCloud scanner
        run: |
          wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
          unzip sonar-scanner-cli-5.0.1.3006-linux.zip
          sudo mv sonar-scanner-5.0.1.3006-linux /opt/sonar-scanner
          echo "/opt/sonar-scanner/bin" >> $GITHUB_PATH

      - name: Building and testing with sonar
        run: |
          # Run backend tests with coverage
          cd backend
          mvn clean test jacoco:report
          cd ..
          
          # Run frontend tests with coverage
          cd frontend
          npm ci
          npm run test:coverage
          cd ..
          
          # Run SonarCloud analysis
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            sonar-scanner \
              -Dsonar.projectKey=fgajic_burgerapp \
              -Dsonar.organization=fgajic \
              -Dsonar.sources=backend/src,frontend/src \
              -Dsonar.java.binaries=backend/target/classes \
              -Dsonar.java.coveragePlugin=jacoco \
              -Dsonar.coverage.jacoco.xmlReportPaths=backend/target/site/jacoco/jacoco.xml \
              -Dsonar.javascript.lcov.reportPaths=frontend/coverage/lcov.info \
              -Dsonar.exclusions="**/node_modules/**,**/target/**,**/*.test.ts,**/*.test.tsx,**/*.spec.ts,**/*.spec.tsx" \
              -Dsonar.pullrequest.key="${{ github.event.pull_request.number }}" \
              -Dsonar.pullrequest.branch="${{ github.head_ref }}" \
              -Dsonar.pullrequest.base="${{ github.base_ref }}" \
              -Dsonar.login="${{ secrets.SONAR_TOKEN }}"
          else
            sonar-scanner \
              -Dsonar.projectKey=fgajic_burgerapp \
              -Dsonar.organization=fgajic \
              -Dsonar.sources=backend/src,frontend/src \
              -Dsonar.java.binaries=backend/target/classes \
              -Dsonar.java.coveragePlugin=jacoco \
              -Dsonar.coverage.jacoco.xmlReportPaths=backend/target/site/jacoco/jacoco.xml \
              -Dsonar.javascript.lcov.reportPaths=frontend/coverage/lcov.info \
              -Dsonar.exclusions="**/node_modules/**,**/target/**,**/*.test.ts,**/*.test.tsx,**/*.spec.ts,**/*.spec.tsx" \
              -Dsonar.branch.name="${{ github.ref_name }}" \
              -Dsonar.login="${{ secrets.SONAR_TOKEN }}"
          fi

  build-push:
    env:
      DOCKER_BUILDKIT: 1
    runs-on: ubuntu-latest
    name: Build push for ${{ matrix.spec.image_name }}:${{ github.sha }}
    environment: staging
    strategy:
      matrix:
        spec:
          [
            {
              image_name: "burgerbuilder-backend",
              dockerfile_path: "backend/Dockerfile",
              context: "backend",
            },
            {
              image_name: "burgerbuilder-frontend",
              dockerfile_path: "frontend/Dockerfile",
              context: "frontend",
            },
          ]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to ACR
        uses: docker/login-action@v3
        with:
          registry: filipbourgerappacr.azurecr.io
          username: ${{ secrets.ACR_DOCKER_USER }}
          password: ${{ secrets.ACR_DOCKER_PAT }}

      - name: Building ${{ matrix.spec.image_name }}:${{ github.sha }}
        run: |
          docker build -t filipbourgerappacr.azurecr.io/${{ matrix.spec.image_name }}:${{ github.sha }} ${{ matrix.spec.context }} -f ${{ matrix.spec.dockerfile_path }}

      - name: Pushing ${{ matrix.spec.image_name }}:${{ github.sha }}
        if: ${{ github.ref == 'refs/heads/master' }}
        shell: bash
        run: |
          docker tag filipbourgerappacr.azurecr.io/${{ matrix.spec.image_name }}:${{ github.sha }} filipbourgerappacr.azurecr.io/${{ matrix.spec.image_name }}:latest
          docker push filipbourgerappacr.azurecr.io/${{ matrix.spec.image_name }}:${{ github.sha }}
          docker push filipbourgerappacr.azurecr.io/${{ matrix.spec.image_name }}:latest
        

  # deploy:
  #   needs: [build-push]
  #   if: ${{ github.ref == 'refs/heads/master' }}
  #   name: Deploying ${{ github.sha }} to staging environment
  #   uses: ./.github/workflows/deploy.yaml
  #   with:
  #     environment: staging
  #     image_tag: ${{ github.sha }}
  #   secrets:
  #     inherit